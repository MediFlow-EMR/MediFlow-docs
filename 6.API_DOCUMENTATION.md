# API 명세서 (API Documentation)

## 핵심 요약

메디플로우 EMR의 REST API는 **OpenAPI 3.0.3** 규격으로 작성되었으며, **JWT 인증** 기반으로 환자 정보, 바이탈 사인, 간호기록, AI 인수인계 등 핵심 의료 데이터를 안전하게 관리합니다. 총 **10개 도메인**, **40개 이상의 엔드포인트**를 제공하며, Swagger UI를 통해 API를 테스트할 수 있습니다.

**기술 규격:**
- 명세 규격: OpenAPI Specification 3.0.3
- 인증 방식: JWT (Bearer Token)
- 응답 형식: JSON
- 버전: v1.1.0

---

## API 문서 확인 방법

### Swagger Editor 사용

1. **[Swagger Editor](https://editor.swagger.io)** 접속
2. 왼쪽 편집기에 **[swagger.yaml](https://github.com/MediFlow-EMR/mediflow-dev/blob/c83c95a04d26893b903c8f6938094bab28f0b7c3/swagger.yaml)** 파일 내용 복사 & 붙여넣기
3. 오른쪽에서 실시간으로 API 문서 확인 및 테스트

### 로컬 Swagger UI 실행
```bash
# Swagger UI Docker 실행
docker run -p 8081:8080 \
  -e SWAGGER_JSON=/swagger.yaml \
  -v $(pwd)/swagger.yaml:/swagger.yaml \
  swaggerapi/swagger-ui

# http://localhost:8081 접속
```

---

## 서버 정보

| 환경 | URL | 설명 |
|-----|-----|------|
| **프로덕션** | `https://api.mediflow-emr.cloud` | 실제 운영 서버 |
| **로컬 개발** | `http://localhost:9005` | 개발 환경 |

---

## API 도메인
![img.png](assets/api-domain.png)

---

## 인증 (Authentication)

### JWT 토큰 구조
```
메디플로우는 Access Token + Refresh Token 이중 토큰 전략을 사용합니다.
```

![img.png](assets/Authentication.png)

### 주요 인증 엔드포인트

| 메서드 | 엔드포인트 | 설명 | 인증 필요 |
|--------|-----------|------|-------|
| `POST` | `/api/auth/join` | 이메일 회원가입 | x     |
| `POST` | `/api/auth/email/login` | 이메일 로그인 | x     |
| `GET` | `/oauth2/authorization/google` | Google 소셜 로그인 | x     |
| `GET` | `/oauth2/authorization/kakao` | Kakao 소셜 로그인 | x     |
| `POST` | `/api/auth/refresh` | Access Token 갱신 | x     |
| `POST` | `/api/auth/logout` | 로그아웃 | o     |

### 인증 헤더 사용법
```bash
# Authorization 헤더에 JWT 토큰 포함
curl -X GET https://api.mediflow-emr.cloud/api/users/me \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

---

## 주요 API 엔드포인트

### 1. Dashboard (대시보드)

**내 담당 환자 목록 조회**
```http
GET /api/dashboard/my-patients
```

**응답 예시:**
```json
{
  "success": true,
  "data": [
    {
      "patientId": 1,
      "chartNumber": "P2024001",
      "name": "홍길동",
      "age": 45,
      "gender": "M",
      "diagnosis": "급성 심근경색",
      "triageLevel": 2,
      "systolicBp": 120,
      "diastolicBp": 80,
      "spo2": 98,
      "lastVitalTime": "2024-11-30T10:30:00"
    }
  ],
  "message": null
}
```

---

### 2. Vital Signs (활력징후)

**바이탈 사인 등록**
```http
POST /api/vitals
Content-Type: application/json

{
  "patientId": 1,
  "systolicBp": 120,
  "diastolicBp": 80,
  "heartRate": 75,
  "bodyTemp": 36.5,
  "spo2": 98,
  "measuredAt": "2024-11-30T10:30:00"
}
```

**환자별 바이탈 조회**
```http
GET /api/vitals/patient/{patientId}
```

---

### 3. Nursing Notes (간호기록)

**간호기록 등록 (리치 텍스트)**
```http
POST /api/nursing-notes
Content-Type: application/json

{
  "patientId": 1,
  "content": "<p><span style='background-color: yellow'>환자 상태 양호</span>, 통증 호소 없음</p>",
  "plainText": "환자 상태 양호, 통증 호소 없음",
  "category": "OBSERVATION",
  "isImportant": false
}
```

**카테고리:**
- `OBSERVATION` (관찰)
- `TREATMENT` (처치)
- `EDUCATION` (교육)
- `CONSULTATION` (상담)
- `MEDICATION` (투약)

---

### 4. Medications (투약)

**투약 기록 등록**
```http
POST /api/medications
Content-Type: application/json

{
  "patientId": 1,
  "drugName": "타이레놀",
  "drugCode": "A01AB01",
  "dose": "500mg",
  "route": "PO",
  "frequency": "TID",
  "administeredAt": "2024-11-30T10:30:00",
  "orderDoctor": "김의사"
}
```

**약품 검색 (식약처 API)**
```http
GET /api/medications/drugs/search?keyword=타이레놀
```

**응답:**
```json
{
  "success": true,
  "data": [
    {
      "itemName": "타이레놀정 500mg",
      "entpName": "한국얀센",
      "itemSeq": "123456789",
      "efcyQesitm": "해열, 진통"
    }
  ]
}
```

---

### 5. Intake/Output (섭취배설량)

**I/O 기록 등록**
```http
POST /api/intake-output
Content-Type: application/json

{
  "patientId": 1,
  "intakeOral": 500,
  "intakeIv": 1000,
  "outputUrine": 800,
  "outputDrain": 200,
  "recordedAt": "2024-11-30T14:00:00"
}
```

**응답 (자동 계산된 총량):**
```json
{
  "success": true,
  "data": {
    "intakeTotal": 1500,
    "outputTotal": 1000,
    "...": "..."
  }
}
```

---

### 6. Medical Orders (의료 오더)

**환자별 오더 조회**
```http
GET /api/orders/patient/{patientId}
```

**오더 유형:**
- `MEDICATION` (투약)
- `LAB` (검사)
- `IMAGING` (영상)
- `PROCEDURE` (처치)

**오더 상태:**
- `PENDING` (대기)
- `IN_PROGRESS` (진행 중)
- `COMPLETED` (완료)
- `CANCELLED` (취소)

**약품 상세 정보 조회**
```http
GET /api/orders/{orderId}/drug-detail
```

---

### 7. Handovers (AI 인수인계)

**AI 요약 생성**
```http
POST /api/handovers/ai-summary?departmentId=1&fromShiftId=1
```

**응답 예시:**
```json
{
  "success": true,
  "data": "[응급실 주간 근무 인수인계]\n\n1. 홍길동(P2024001) - 급성 심근경색\n   - 바이탈: BP 120/80, HR 75, BT 36.5°C\n   - 특이사항: 통증 호소 없음, 상태 안정적"
}
```

**인수인계 저장**
```http
POST /api/handovers?departmentId=1&fromShiftId=1&toShiftId=2
Content-Type: text/plain

[응급실 주간 근무 인수인계]

1. 홍길동(P2024001) - 급성 심근경색
   - 바이탈: BP 120/80, HR 75, BT 36.5°C
   - 특이사항: 통증 호소 없음, 상태 안정적
```

---

## 공통 응답 구조

### 성공 응답
```json
{
  "success": true,
  "data": { ... },
  "message": "바이탈 사인이 등록되었습니다"
}
```

### 에러 응답
```json
{
  "success": false,
  "data": null,
  "message": "이메일 형식이 올바르지 않습니다."
}
```

### HTTP 상태 코드

| 코드 | 설명 | 예시 |
|-----|------|------|
| `200` | 성공 | 데이터 조회/등록 성공 |
| `204` | 성공 (응답 본문 없음) | 로그아웃, 토큰 갱신 |
| `400` | 잘못된 요청 | 유효성 검증 실패 |
| `401` | 인증 실패 | 토큰 만료, 로그인 필요 |
| `403` | 권한 없음 | 다른 간호사의 기록 수정 시도 |
| `404` | 리소스 없음 | 환자/기록을 찾을 수 없음 |
| `409` | 충돌 | 이미 존재하는 이메일 |
| `500` | 서버 오류 | 내부 서버 오류 |

---

## 보안 및 제약 사항

### 데이터 검증

**바이탈 사인 범위:**
- 혈압: 50-250 / 30-150 mmHg
- 심박수: 30-250 bpm
- 체온: 35.0-42.0 °C
- 산소포화도: 70-100 %

**섭취배설량 범위:**
- 모든 값: 0-5000 mL

**문자열 길이:**
- 간호기록 (content/plainText): 최대 10,000자
- 약물명 (drugName): 최대 200자
- 용량 (dose): 최대 100자

### 권한 관리
![img.png](assets/role.png)

**규칙:**
- 바이탈 사인, 간호기록, 투약 기록: **작성자만** 수정/삭제 가능
- 환자 정보: **같은 부서 간호사** 조회 가능
- 인수인계: **작성자 + 수간호사** 삭제 가능

---

## API 테스트 예시

### cURL
```bash
# 1. 로그인
curl -X POST https://api.mediflow-emr.cloud/api/auth/email/login \
  -H "Content-Type: application/json" \
  -d '{"email": "nurseer1@mediflow.com", "password": "nurse123@"}' \
  -c cookies.txt

# 2. 담당 환자 조회
curl -X GET https://api.mediflow-emr.cloud/api/dashboard/my-patients \
  -b cookies.txt

# 3. 바이탈 사인 등록
curl -X POST https://api.mediflow-emr.cloud/api/vitals \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{
    "patientId": 1,
    "systolicBp": 120,
    "diastolicBp": 80,
    "heartRate": 75,
    "bodyTemp": 36.5,
    "spo2": 98
  }'
```

### JavaScript (Axios)
```javascript
import axios from 'axios';

const api = axios.create({
  baseURL: 'https://api.mediflow-emr.cloud',
  withCredentials: true // 쿠키 포함
});

// 로그인
const login = async () => {
  const response = await api.post('/api/auth/email/login', {
    email: 'nurse@mediflow.com',
    password: 'password123!'
  });
  return response.data;
};

// 담당 환자 조회
const getMyPatients = async () => {
  const response = await api.get('/api/dashboard/my-patients');
  return response.data.data;
};

// 바이탈 사인 등록
const createVitalSign = async (data) => {
  const response = await api.post('/api/vitals', data);
  return response.data;
};
```

---